/* função de agregação */

/* querry simples */

SELECT * FROM FUNCIONARIOS;

/* CONTANDO O NUMERO DE OCORRÊNCIAS */

SELECT COUNT(*) FROM FUNCIONARIOS;
SELECT COUNT(*) FROM DEPARTAMENTOS;
SELECT COUNT(*) FROM LOCALIZACAO;

/* AGRUPANDO POR SEXO COM GROUP BY */

SELECT SEXO, COUNT(*) AS "QUANTIDADE" FROM FUNCIONARIOS
GROUP BY SEXO;

/* MOSTRANDO O NÚMERO DE FUNCIONÁRIOS DE CADA DEPARTAMENTO */

SELECT DEPARTAMENTO, COUNT(*) FROM FUNCIONARIOS
GROUP BY DEPARTAMENTO;

/* EXIBINDO O MÁXIMO DE SALÁRIOS */

SELECT MAX(SALARIO) AS "MAIOR SALÁRIO" FROM FUNCIONARIOS;

/* EXIBINDO O MÍNIMO DE SALÁRIOS */

SELECT MIN(SALARIO) AS "MENOR SALÁRIO" FROM FUNCIONARIOS;

/* EXIBINDO O MÍNIMO E O MÁXIMO DE CADA DEPARTAMENTO */

SELECT DEPARTAMENTO, MIN(SALARIO) AS "MENOR SALARIO", MAX(SALARIO) AS "MAIOR SALARIO" FROM FUNCIONARIOS
GROUP BY DEPARTAMENTO;


/* estatísticas */

/* mostrando uma quantidade limitada de linhas */

SELECT * FROM FUNCIONARIOS LIMIT 10;

/* QUAL O GASTO TOTAL DE SALÁRIO GASTO PELA EMPRESA */

SELECT SUM(SALARIO) FROM FUNCIONARIOS;

/* QUAL O MONTANTE TOTAL QUE CADA DEPARTAMENTO RECEBE */

SELECT DEPARTAMENTO, SUM(SALARIO) FROM FUNCIONARIOS
GROUP BY DEPARTAMENTO;

/* POR DEPARTAMENTO QUAL O TOTAL E A MÉDIA PAGA PARA OS FUNCIONARIOS */

SELECT DEPARTAMENTO, SUM(SALARIO), AVG(SALARIO) FROM FUNCIONARIOS
GROUP BY DEPARTAMENTO;

/* ORDENANDO */

SELECT DEPARTAMENTO, SUM(SALARIO), AVG(SALARIO) FROM FUNCIONARIOS
GROUP BY DEPARTAMENTO
ORDER BY 3;


/* IMPORTANDO CSV */

CREATE TABLE MAQUINAS(
    MAQUINAS VARCHAR(20),
    DIA INT,
    QTD NUMERIC(10,2)
);

COPY MAQUINAS FROM 'C:\Users\Gabriel\Downloads\\LogMaquinas.csv' 
DELIMITER ','
CSV HEADER;

/* QUAL A MEDIA DE CADA MAQUINA */

SELECT MAQUINAS, AVG(QTD) FROM MAQUINAS
GROUP BY MAQUINAS;

/* ARREDONDANDO */

SELECT MAQUINAS, ROUND(AVG(QTD),2) FROM MAQUINAS
GROUP BY MAQUINAS
ORDER BY 2 DESC;


/* QUAL A MODA DE TODAS AS QUANTIDADES */

SELECT MAQUINAS, QTD, COUNT(*) FROM MAQUINAS
GROUP BY MAQUINAS, QTD
ORDER BY 3 DESC;

/* MODA DE  CADA MAQUINA */

SELECT MAQUINAS, QTD, COUNT(*) FROM MAQUINAS
WHERE MAQUINAS = 'Maquina 01'
GROUP BY MAQUINAS, QTD
ORDER BY 3 DESC;

/* MODA DO DATASET INTEIRO */

SELECT QTD, COUNT(*) FROM MAQUINAS
GROUP BY QTD
ORDER BY 2 DESC;

/* QUAL O MÁXIMO, MÍNIMO E AMPLITUDE DE CADA MAQUINA */

SELECT MAQUINAS, MAX(QTD) AS MAXIMO, MIN(QTD) AS MINIMO, MAX(QTD) - MIN(QTD) AS AMPLITUDE FROM MAQUINAS
GROUP BY MAQUINAS
ORDER BY 4 DESC;

/* DESVIO PADRAO E VARIANCIA */

SELECT MAQUINAS, STDDEV_POP(QTD) AS "DESVIO PADRAO", VAR_POP(QTD) AS "VARIANCIA"
FROM MAQUINAS
GROUP BY MAQUINAS
ORDER BY 2;


/* CRIANDO FUNÇÃO PARA MEDIANA */

CREATE OR REPLACE FUNCTION _final_median(NUMERIC[])
    RETURNS NUMERIC AS
$$
    SELECT AVG(val)
    FROM (
        SELECT val
        FROM unnest ($1) val
        ORDER BY 1
        LIMIT 2 - MOD(array_upper($1, 1), 2)
        OFFSET CEIL(array_upper($1, 1) / 2.0) - 1
    ) sub;
$$
LANGUAGE 'sql' IMMUTABLE;

CREATE AGGREGATE median(numeric) (
  SFUNC=array_append,
  STYPE=numeric[],
  FINALFUNC=_final_median,
  INITCOND='{}'
);

/* ENCONTRANDO A MEDIANA */

SELECT MEDIAN(QTD) AS MEDIANA
FROM MAQUINAS
WHERE MAQUINAS = 'Maquina 01';

/* MAIS ALGUNS INSERT */

INSERT INTO MAQUINAS VALUES('Maquina 01',11,15.9);
INSERT INTO MAQUINAS VALUES('Maquina 02',11,15.4);
INSERT INTO MAQUINAS VALUES('Maquina 03',11,15.7);
INSERT INTO MAQUINAS VALUES('Maquina 01',12,30);
INSERT INTO MAQUINAS VALUES('Maquina 02',12,24);
INSERT INTO MAQUINAS VALUES('Maquina 03',12,45);


SELECT MAQUINAS, COUNT(QTD) AS "QUANTIDADE", SUM(QTD) AS "TOTAL", ROUND(AVG(QTD),2) AS "MÉDIA", MAX(QTD) AS "MÁXIMO", MIN(QTD) AS "MÍNIMO", MAX(QTD) - MIN(QTD) AS "AMPLITUDE TOTAL", ROUND(VAR_POP(QTD),2) AS "VARIANCIA", ROUND(STDDEV_POP(QTD),2) AS "DESVIO PADRAO", ROUND(MEDIAN(QTD),2) AS "MEDIANA", ROUND((STDDEV_POP(QTD) / AVG(QTD)) * 100,2) AS "COEFICIENTE VARIAÇÃO"
FROM MAQUINAS
GROUP BY MAQUINAS
ORDER BY 1; 


/* MODA - MODE() WITHIN GROUP(ORDER BY COLUNA) */

SELECT MODE() WITHIN GROUP(ORDER BY QTD) AS "MODA" FROM MAQUINAS;

SELECT MAQUINAS,MODE() WITHIN GROUP(ORDER BY QTD) AS "MODA" FROM MAQUINAS
GROUP BY MAQUINAS;

SELECT MAQUINAS, COUNT(QTD) AS "QUANTIDADE", SUM(QTD) AS "TOTAL", ROUND(AVG(QTD),2) AS "MÉDIA", MAX(QTD) AS "MÁXIMO", MIN(QTD) AS "MÍNIMO", MAX(QTD) - MIN(QTD) AS "AMPLITUDE TOTAL", ROUND(VAR_POP(QTD),2) AS "VARIANCIA", ROUND(STDDEV_POP(QTD),2) AS "DESVIO PADRAO", ROUND(MEDIAN(QTD),2) AS "MEDIANA", ROUND((STDDEV_POP(QTD) / AVG(QTD)) * 100,2) AS "COEFICIENTE VARIAÇÃO", MODE() WITHIN GROUP(ORDER BY QTD) AS "MODA"
FROM MAQUINAS
GROUP BY MAQUINAS
ORDER BY 1;

/* EXPORTANDO UMA TABELA */

CREATE TABLE REL_MAQUINAS AS SELECT MAQUINAS, COUNT(QTD) AS "QUANTIDADE", SUM(QTD) AS "TOTAL", ROUND(AVG(QTD),2) AS "MÉDIA", MAX(QTD) AS "MÁXIMO", MIN(QTD) AS "MÍNIMO", MAX(QTD) - MIN(QTD) AS "AMPLITUDE TOTAL", ROUND(VAR_POP(QTD),2) AS "VARIANCIA", ROUND(STDDEV_POP(QTD),2) AS "DESVIO PADRAO", ROUND(MEDIAN(QTD),2) AS "MEDIANA", ROUND((STDDEV_POP(QTD) / AVG(QTD)) * 100,2) AS "COEFICIENTE VARIAÇÃO", MODE() WITHIN GROUP(ORDER BY QTD) AS "MODA"
FROM MAQUINAS
GROUP BY MAQUINAS
ORDER BY 1;

COPY REL_MAQUINAS TO 'C:\Users\Gabriel\Desktop\Cursos\SQL\POSTGRE\REL_MAQUINAS.csv'
DELIMITER ';'
CSV HEADER;


CREATE TABLE GENERO(
	IDGENERO INT PRIMARY KEY,
	NOME VARCHAR(30)
);

INSERT INTO GENERO VALUES(1,'FANTASIA');
INSERT INTO GENERO VALUES(2,'AVENTURA');
INSERT INTO GENERO VALUES(3,'SUSPENSE');
INSERT INTO GENERO VALUES(4,'AÇÃO');
INSERT INTO GENERO VALUES(5,'DRAMA');

CREATE TABLE FILME(
	IDFILME INT PRIMARY KEY,
	NOME VARCHAR(50),
	ANO INT,
    ID_GENERO INT,
	FOREIGN KEY(ID_GENERO)
	REFERENCES GENERO(IDGENERO)
);

INSERT INTO FILME VALUES(100,'KILL BILL I',2007,2);
INSERT INTO FILME VALUES(200,'DRACULA',1998,3);
INSERT INTO FILME VALUES(300,'SENHOR DOS ANEIS',2008,1);
INSERT INTO FILME VALUES(400,'UM SONHO DE LIBERDADE',2008,5);
INSERT INTO FILME VALUES(500,'OS BAD BOYS',2008,4);
INSERT INTO FILME VALUES(600,'GUERRA CIVIL',2016,2);
INSERT INTO FILME VALUES(700,'CADILLAC RECORDS',2009,5);
INSERT INTO FILME VALUES(800,'O HOBBIT',2008,1);
INSERT INTO FILME VALUES(900,'TOMATES VERDES FRITOS',2008,5);
INSERT INTO FILME VALUES(1000,'CORRIDA MORTAL',2008,4);

CREATE TABLE LOCACAO(
	IDLOCACAO INT PRIMARY KEY,
	DATA DATE,
	MIDIA INT,
	DIAS INT,
	ID_FILME INT,
	FOREIGN KEY(ID_FILME)
	REFERENCES FILME(IDFILME)

);

select * from locacao

INSERT INTO LOCACAO VALUES(1,'01/08/2019',23,3,100);
INSERT INTO LOCACAO VALUES(2,'01/02/2019',56,1,400);
INSERT INTO LOCACAO VALUES(3,'02/07/2019',23,3,400);
INSERT INTO LOCACAO VALUES(4,'02/02/2019',43,1,500);
INSERT INTO LOCACAO VALUES(5,'02/02/2019',23,2,100);
INSERT INTO LOCACAO VALUES(6,'03/07/2019',76,3,700);
INSERT INTO LOCACAO VALUES(7,'03/02/2019',45,1,700);
INSERT INTO LOCACAO VALUES(8,'04/08/2019',89,3,100);
INSERT INTO LOCACAO VALUES(9,'04/02/2019',23,3,800);
INSERT INTO LOCACAO VALUES(10,'05/07/2019',23,3,500);
INSERT INTO LOCACAO VALUES(11,'05/02/2019',38,3,800);
INSERT INTO LOCACAO VALUES(12,'01/10/2019',56,1,100);
INSERT INTO LOCACAO VALUES(13,'06/12/2019',23,3,400);
INSERT INTO LOCACAO VALUES(14,'01/02/2019',56,2,300);
INSERT INTO LOCACAO VALUES(15,'04/10/2019',76,3,300);
INSERT INTO LOCACAO VALUES(16,'01/09/2019',32,2,400);
INSERT INTO LOCACAO VALUES(17,'08/02/2019',89,3,100);
INSERT INTO LOCACAO VALUES(18,'01/02/2019',23,1,200);
INSERT INTO LOCACAO VALUES(19,'08/09/2019',45,3,300);
INSERT INTO LOCACAO VALUES(20,'01/12/2019',89,1,400);
INSERT INTO LOCACAO VALUES(21,'09/07/2019',23,3,1000);
INSERT INTO LOCACAO VALUES(22,'01/12/2019',21,3,1000);
INSERT INTO LOCACAO VALUES(23,'01/02/2019',34,2,100);
INSERT INTO LOCACAO VALUES(24,'09/08/2019',67,1,1000);
INSERT INTO LOCACAO VALUES(25,'01/02/2019',76,3,1000);
INSERT INTO LOCACAO VALUES(26,'01/02/2019',66,3,200);
INSERT INTO LOCACAO VALUES(27,'09/12/2019',90,1,400);
INSERT INTO LOCACAO VALUES(28,'03/02/2019',23,3,100);
INSERT INTO LOCACAO VALUES(29,'01/12/2019',65,5,1000);
INSERT INTO LOCACAO VALUES(30,'03/08/2019',43,1,1000);
INSERT INTO LOCACAO VALUES(31,'01/02/2019',27,31,200);


SELECT F.NOME, G.NOME, L.DATA, L.DIAS, L.MIDIA
FROM GENERO G
INNER JOIN FILME F
ON G.IDGENERO = F.ID_GENERO
INNER JOIN LOCACAO L
ON L.ID_FILME = F.IDFILME;

CREATE TABLE REL_LOCADORA AS
SELECT F.NOME AS FILME, G.NOME AS GENERO, L.DATA AS DATA, L.DIAS AS DIAS, L.MIDIA AS MIDIA
FROM GENERO G
INNER JOIN FILME F
ON G.IDGENERO = F.ID_GENERO
INNER JOIN LOCACAO L
ON L.ID_FILME = F.IDFILME;

COPY REL_LOCADORA TO 'C:\Users\Gabriel\Desktop\Cursos\SQL\POSTGRE\REL_LOCADORA.csv'
DELIMITER ';'
CSV HEADER;

/* SINCRONIZANDO TABELAS E RELATORIOS */

DROP TABLE LOCACAO;

CREATE TABLE LOCACAO(
    IDLOCACAO INT PRIMARY KEY,
    DATA TIMESTAMP,
    MIDIA INT,
    DIAS INT,
    ID_FILME INT,
    FOREIGN KEY (ID_FILME) REFERENCES FILME(IDFILME)
);

CREATE SEQUENCE SEQ_LOCACAO;

INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'01/08/2018',23,3,100);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'01/02/2018',56,1,400);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'02/07/2018',23,3,400);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'02/02/2018',43,1,500);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'02/02/2018',23,2,100);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'03/07/2018',76,3,700);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'03/02/2018',45,1,700);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'04/08/2018',89,3,100);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'04/02/2018',23,3,800);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'05/07/2018',23,3,500);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'05/02/2018',38,3,800);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'01/10/2018',56,1,100);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'06/12/2018',23,3,400);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'01/02/2018',56,2,300);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'04/10/2018',76,3,300);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'01/09/2018',32,2,400);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'08/02/2018',89,3,100);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'01/02/2018',23,1,200);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'08/09/2018',45,3,300);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'01/12/2018',89,1,400);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'09/07/2018',23,3,1000);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'01/12/2018',21,3,1000);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'01/02/2018',34,2,100);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'09/08/2018',67,1,1000);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'01/02/2018',76,3,1000);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'01/02/2018',66,3,200);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'09/12/2018',90,1,400);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'03/02/2018',23,3,100);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'01/12/2018',65,5,1000);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'03/08/2018',43,1,1000);
INSERT INTO LOCACAO VALUES(NEXTVAL('SEQ_LOCACAO'),'01/02/2018',27,31,200);

DROP TABLE REL_LOCADORA;

SELECT L.IDLOCACAO, F.NOME AS "FILME", G.NOME AS "GENERO", L.DATA AS "DATA", L.DIAS AS "DIAS", L.MIDIA AS "MIDIA"
FROM GENERO G
INNER JOIN FILME F
ON G.IDGENERO = F.ID_GENERO
INNER JOIN LOCACAO L
ON L.ID_FILME = F. IDFILME;

CREATE TABLE REL_LOCADORA AS 
SELECT L.IDLOCACAO, F.NOME AS "FILME", G.NOME AS "GENERO", L.DATA AS "DATA", L.DIAS AS "DIAS", L.MIDIA AS "MIDIA"
FROM GENERO G
INNER JOIN FILME F
ON G.IDGENERO = F.ID_GENERO
INNER JOIN LOCACAO L
ON L.ID_FILME = F. IDFILME;

/* SELECT PARA TRAZER REGISTROS NOVOS */

SELECT MAX(IDLOCACAO) AS "RELATORIO", (SELECT MAX(IDLOCACAO) FROM LOCACAO) AS "LOCACAO" FROM REL_LOCADORA;

SELECT L.IDLOCACAO, F.NOME AS "FILME", G.NOME AS "GENERO", L.DATA AS "DATA", L.DIAS AS "DIAS", L.MIDIA AS "MIDIA"
FROM GENERO G
INNER JOIN FILME F
ON G.IDGENERO = F.ID_GENERO
INNER JOIN LOCACAO L
ON L.ID_FILME = F. IDFILME
WHERE IDLOCACAO NOT IN (SELECT IDLOCACAO FROM REL_LOCADORA)
;

/* INSERINDO O REGISTROS NOVOS */

INSERT INTO REL_LOCADORA
SELECT L.IDLOCACAO, F.NOME AS "FILME", G.NOME AS "GENERO", L.DATA AS "DATA", L.DIAS AS "DIAS", L.MIDIA AS "MIDIA"
FROM GENERO G
INNER JOIN FILME F
ON G.IDGENERO = F.ID_GENERO
INNER JOIN LOCACAO L
ON L.ID_FILME = F. IDFILME
WHERE IDLOCACAO NOT IN (SELECT IDLOCACAO FROM REL_LOCADORA)
;

/* DEIXANDO AUTOMÁTICO POR MEIO DE UMA TRIGGER */